# 🔧 高德地图API修复指南

## ❌ 当前错误
```
Geocode response: status=0, info=USERKEY_PLAT_NOMATCH, count=0
```

**错误含义**：API密钥与平台不匹配或无效

## 🚨 解决步骤

### 步骤1：检查高德开发者控制台

1. **登录高德开放平台**
   - 访问：https://lbs.amap.com/
   - 使用账号登录

2. **检查API密钥**
   - 进入"控制台" → "应用管理" → "我的应用"
   - 找到当前使用的API Key: `e3064e9e20ff62d8ebb59d24d634c179`
   - 确认密钥状态为"已发布"

### 步骤2：检查服务权限

1. **确保开启Web服务API**
   - 在应用详情中，点击"绑定服务"
   - 确保"Web服务API"已勾选
   - 特别确认"地理编码"服务已启用

2. **检查配额使用情况**
   - 查看每日配额是否已用完
   - 如果用完了，需要等到第二天重置或申请更高配额

### 步骤3：检查域名/IP白名单

1. **检查安全设置**
   - 在应用设置中，找到"安全码"或"白名单"设置
   - 如果设置了域名/IP白名单，确保包含：
     - `127.0.0.1` (本地开发)
     - `localhost`
     - `*` (允许所有域名，仅开发时使用)

### 步骤4：重新创建API密钥（如果需要）

1. **创建新应用**
   ```
   应用名称：中珠外卖系统
   应用类型：其他
   ```

2. **绑定服务**
   - ✅ Web服务API
   - ✅ 地理编码服务

3. **获取新密钥**
   - 复制新生成的Key

### 步骤5：更新代码中的API密钥

**文件位置**：`backend/utils/geo_amap.go`

```go
var amapKey = "你的新API密钥" // 替换这行
```

## 🧪 测试API修复

### 1. 手动测试API
在浏览器中访问：
```
https://restapi.amap.com/v3/geocode/geo?key=你的API密钥&address=广东省珠海市香洲区中山大学珠海校区榕园&output=json
```

**期望响应**：
```json
{
  "status": "1",
  "info": "OK",
  "geocodes": [
    {
      "location": "113.529400,22.358400"
    }
  ]
}
```

### 2. 重启后端测试
```bash
cd backend
go run main.go
```

然后测试送达功能，应该看到：
```
✅ [后端地址解析] 成功: "广东省珠海市香洲区中大珠海校区榕园201" -> (22.35840000, 113.52940000)
```

## 🆘 常见问题

### Q: 仍然提示USERKEY_PLAT_NOMATCH？
**A**:
1. 确认API密钥复制正确（无空格）
2. 等待5-10分钟，新密钥需要时间生效
3. 检查是否绑定了正确的服务

### Q: 提示INVALID_USER_KEY？
**A**: API密钥完全无效，需要重新申请

### Q: 提示OVER_QUOTA？
**A**: 配额用完，需要升级服务或等待重置

## 📞 联系高德技术支持

如果问题持续存在：
- 高德技术支持QQ群：204033376
- 官方文档：https://lbs.amap.com/api/webservice/guide/api/geocode
- 工单支持：https://lbs.amap.com/console/feedback

## ⚡ 临时解决方案（仅开发测试）

如果急需测试，可以先临时移除API验证：

```go
// 临时跳过API验证（仅用于测试！）
destLat, destLon = 22.3584, 113.5294 // 榕园坐标
```

**⚠️ 警告**：这是临时方案，生产环境必须修复API！