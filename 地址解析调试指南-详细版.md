# 地址解析调试指南 - 详细版

## 问题现象
- 地图显示所有位置都在中山大学默认位置
- 错误: `AMap.Geocoder is not a constructor`

## 已完成的调试增强

### 1. 前端调试日志
打开浏览器开发者工具（F12）→ Console 面板，现在会看到：

#### 页面加载时
```
📦 === 订单数据加载完成 ===
📋 订单总数: X
📊 待取餐订单数 (status=3): X
📊 派送中订单数 (status=4): X

📍 订单1 [ID:123] 地址信息:
  🏪 商家: 餐厅名称
  📮 pickupAddress: "商家地址" (长度: X)
  🏠 客户: 客户姓名
  📍 deliveryAddress: "配送地址" (长度: X)
  📋 状态: 3 (待取餐/派送中)
```

#### 点击位置按钮时
```
📍 === 商家位置调试信息 ===
📋 订单ID: 123
🏪 商家名称: 餐厅名称
📮 商家地址 (pickupAddress): "商家地址"
📊 地址长度: X
🏠 客户名称: 客户姓名
📍 配送地址 (deliveryAddress): "配送地址"
📊 配送地址长度: X
📋 订单状态: 3
🏷️ 地址来源说明: 商家使用 pickupAddress 字段
🏷️ 地址来源说明: 用户使用 deliveryAddress 字段
=====================================
```

#### 地图加载时
```
✅ AMap already loaded, plugins available: [AMap.Geocoder, AMap.Marker, ...]
✅ AMap.Geocoder plugin is loaded
```

#### 地址解析时
```
=== 地址解析调试信息 ===
解析地址数据: { title: "商家", address: "商家地址", type: "merchant", addressLength: X }
AMap.Geocoder available: function
开始地址解析: 商家地址
地理编码结果: { status: "complete", result: {...}, hasGeocodes: 1 }

✅ 地址解析成功: {
  原地址: "商家地址",
  经度: 113.123456,
  纬度: 22.123456,
  解析级别: "兴趣点",
  匹配度: 100
}
```

### 2. 后端调试日志
后端控制台会输出：

#### 订单查询时
```
📍 [订单地址调试] ID:123, 状态:3
  🏪 商家: 餐厅名称
  📮 pickupAddress: "商家地址" (长度:X)
  🏠 客户: 客户姓名
  📍 deliveryAddress: "配送地址" (长度:X)
  🏗️ 地址组件: 省="广东省",市="珠海市",区="香洲区",街="唐家湾",详="中山大学珠海校区"
```

#### 送达确认时（地址解析）
```
🗺️ [后端地址解析] 准备解析地址: "广东省珠海市香洲区中山大学珠海校区荔园"
🏗️ [后端地址解析] 地址组件: 省份="广东省", 城市="珠海市", 区县="香洲区", 街道="唐家湾", 详情="中山大学珠海校区荔园"

🌍 [parseAddressToCoords] 输入地址: "广东省珠海市香洲区中山大学珠海校区荔园" (长度:25)
🔍 [parseAddressToCoords] 调用 utils.GeoCode 解析地址

✅ [parseAddressToCoords] 解析成功: "广东省珠海市香洲区中山大学珠海校区荔园" -> lng=113.531000, lat=22.359800
📍 [parseAddressToCoords] 返回: lat=22.359800, lon=113.531000

✅ [后端地址解析] 成功: "广东省珠海市香洲区中山大学珠海校区荔园" -> (22.359800, 113.531000)
```

## 排查步骤

### 第1步：检查前端地址数据
1. 打开骑手端进行中页面
2. 查看 Console 输出的订单数据
3. 确认 pickupAddress 和 deliveryAddress 是否有值

**可能的发现：**
- ✅ 地址有值且长度 > 0 → 问题在地图解析
- ❌ 地址为空或长度=0 → 问题在后端数据

### 第2步：检查 AMap.Geocoder 插件
1. 查看地图加载日志
2. 确认是否显示 `✅ AMap.Geocoder plugin is loaded`
3. 如果显示 `❌ AMap.Geocoder plugin NOT loaded` → 插件加载失败

**插件加载失败的解决方案：**
- 检查网络连接
- 确认高德地图API密钥有效
- 检查是否有脚本加载错误

### 第3步：检查地址解析过程
1. 点击"查看商家位置"或"查看用户位置"
2. 查看 `=== 地址解析调试信息 ===` 后的日志
3. 确认是显示成功还是失败

### 第4步：检查后端地址数据
查看后端控制台日志：
```
📍 [订单地址调试] ID:123, 状态:3
  📮 pickupAddress: "..." (长度:X)
  📍 deliveryAddress: "..." (长度:X)
```

## 常见问题诊断

### 问题1：地址为空
**前端日志：**
```
📮 pickupAddress: "" (长度:0)
📍 deliveryAddress: "" (长度:0)
```

**后端日志：**
```
📮 pickupAddress: "" (长度:0)
📍 deliveryAddress: "" (长度:0)
```

**解决方案：**
检查数据库中的 `shop_location` 和地址表数据是否为空

### 问题2：插件未加载
**前端日志：**
```
❌ AMap.Geocoder plugin NOT loaded
AMap.Geocoder is not a constructor
```

**解决方案：**
1. 检查 `utils/amap.ts` 中的插件配置
2. 确认网络能访问 `webapi.amap.com`
3. 检查高德地图API密钥

### 问题3：地址解析失败
**前端日志：**
```
❌ 地址解析失败: {
  地址: "xxx",
  状态: "no_data",
  错误信息: "NO_DATA"
}
```

**解决方案：**
1. 检查地址是否包含省市区信息
2. 测试使用更详细的地址格式
3. 检查高德地图配额是否用完

### 问题4：后端地址解析失败
**后端日志：**
```
❌ [parseAddressToCoords] utils.GeoCode 失败: geocode failed: INVALID_PARAMS
```

**解决方案：**
1. 检查 `utils/geo_amap.go` 中的API调用
2. 确认高德地图Web服务API密钥
3. 检查网络能访问 `restapi.amap.com`

## 数据流检查清单

### 前端数据流
- [ ] 订单API返回包含 pickupAddress
- [ ] 订单API返回包含 deliveryAddress
- [ ] AMap SDK加载成功
- [ ] AMap.Geocoder插件可用
- [ ] 地址数据传递给AmapModal组件

### 后端数据流
- [ ] orders.go查询正确获取 shop_location
- [ ] orders.go查询正确获取地址组件
- [ ] buildAddr函数正确拼接地址
- [ ] parseAddressToCoords函数调用成功
- [ ] utils.GeoCode调用高德API成功

## 测试用例

### 推荐测试地址
```
✅ 完整地址: "广东省珠海市香洲区中山大学珠海校区榕园4号"
✅ 标准地址: "珠海市香洲区中山大学珠海校区荔园"
✅ 详细地址: "中山大学珠海校区榕园4号宿舍楼"

❌ 过于简单: "食堂"
❌ 模糊地址: "1栋"
❌ 空地址: ""
```

## 最终确认步骤

1. **同时打开前端和后端控制台**
2. **点击"查看商家位置"按钮**
3. **观察完整的数据流日志：**
   - 前端地址数据输出
   - 地图插件加载状态
   - 地址解析过程
   - 后端数据查询结果

通过这些详细的调试信息，你可以快速定位是：
- **地址数据问题**（后端返回空值）
- **地图插件问题**（AMap.Geocoder未加载）
- **地址解析问题**（高德API调用失败）
- **网络权限问题**（无法访问地图服务）

现在你可以根据具体的日志输出来定位和解决问题了！