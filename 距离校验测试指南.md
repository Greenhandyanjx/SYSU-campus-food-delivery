# è·ç¦»æ ¡éªŒåŠŸèƒ½æµ‹è¯•å’Œä¿®å¤

## é—®é¢˜åˆ†æ
ç”¨æˆ·æŠ¥å‘Šï¼šéª‘æ‰‹ä½ç½®æ˜æ˜¾å’Œç”¨æˆ·ä½ç½®æœ‰å¾ˆè¿œçš„è·ç¦»ï¼Œä½†æ˜¯å¯ä»¥ç‚¹é€è¾¾ã€‚

è¿™æ„å‘³ç€è·ç¦»æ ¡éªŒåŠŸèƒ½æ²¡æœ‰æ­£å¸¸å·¥ä½œã€‚å¯èƒ½çš„åŸå› ï¼š

1. **éª‘æ‰‹ä½ç½®æ²¡æœ‰æ­£ç¡®æ›´æ–°åˆ°æ•°æ®åº“**
2. **è·ç¦»è®¡ç®—å‡½æ•°æœ‰é—®é¢˜**
3. **è®¢å•çŠ¶æ€æ£€æŸ¥ä¸æ­£ç¡®**
4. **APIæ¥å£æ²¡æœ‰è¢«æ­£ç¡®è°ƒç”¨**

## å·²æ·»åŠ çš„è°ƒè¯•ä¿¡æ¯

### åç«¯è°ƒè¯•æ—¥å¿—ï¼š
1. **ä½ç½®æ›´æ–°API** (`/api/rider/location`)ï¼š
   - è®°å½•æ¥æ”¶åˆ°çš„éª‘æ‰‹ä½ç½®æ•°æ®
   - è®°å½•æ•°æ®åº“æ›´æ–°ç»“æœ
   - è®°å½•Profileåˆ›å»ºè¿‡ç¨‹

2. **é€è¾¾API** (`/api/rider/orders/:id/deliver`)ï¼š
   - è®°å½•éª‘æ‰‹ä½ç½®æŸ¥è¯¢ç»“æœ
   - è®°å½•åœ°å€è§£æè¿‡ç¨‹
   - è®°å½•è·ç¦»è®¡ç®—ç»“æœ
   - è®°å½•è·ç¦»æ ¡éªŒè¿‡ç¨‹

### å‰ç«¯è°ƒè¯•æ—¥å¿—ï¼š
1. **ä½ç½®ä¸ŠæŠ¥**ï¼š
   - è®°å½•å‡†å¤‡ä¸ŠæŠ¥çš„ä½ç½®æ•°æ®
   - è®°å½•TokençŠ¶æ€
   - è®°å½•æœåŠ¡å™¨å“åº”

## æµ‹è¯•æ­¥éª¤

### 1. æ£€æŸ¥éª‘æ‰‹ä½ç½®æ˜¯å¦æ­£åœ¨ä¸ŠæŠ¥
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸ“ [ä½ç½®ä¸ŠæŠ¥] å‡†å¤‡ä¸ŠæŠ¥ä½ç½®: {latitude: xxx, longitude: xxx, hasToken: true, tokenLength: xxx}
âœ… [ä½ç½®ä¸ŠæŠ¥] æˆåŠŸä¸ŠæŠ¥ (1): {position: xxx, serverResponse: xxx}
```

### 2. æ£€æŸ¥åç«¯æ˜¯å¦æ”¶åˆ°ä½ç½®æ›´æ–°
åœ¨åç«¯æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸ“ [ä½ç½®æ›´æ–°] æ”¶åˆ°éª‘æ‰‹ä½ç½®æ›´æ–°è¯·æ±‚: baseUserID=xxx, lat=xxx, lng=xxx
âœ… [ä½ç½®æ›´æ–°] æ›´æ–°ç»“æœ: RowsAffected=1
âœ… [ä½ç½®æ›´æ–°] ä½ç½®æ›´æ–°å®Œæˆ: baseUserID=xxx
```

### 3. æµ‹è¯•è·ç¦»æ ¡éªŒ
å°è¯•ç¡®è®¤é€è¾¾æ—¶ï¼ŒæŸ¥çœ‹åç«¯æ§åˆ¶å°æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
```
ğŸš¨ [è·ç¦»æ ¡éªŒ] è·ç¦»æ£€æŸ¥:
   ğŸï¸ éª‘æ‰‹ä½ç½®: lat=xxx, lng=xxx
   ğŸ“ ç›®æ ‡ä½ç½®: lat=xxx, lng=xxx
   ğŸ“ è®¡ç®—è·ç¦»: xxxç±³
   âš ï¸ è·ç¦»é˜ˆå€¼: 150ç±³
âŒ [è·ç¦»æ ¡éªŒå¤±è´¥] è·ç¦»è¶…å‡ºé™åˆ¶: xxx > 150
```

## å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šéª‘æ‰‹ä½ç½®æ²¡æœ‰ä¸ŠæŠ¥
**ç—‡çŠ¶**ï¼šå‰ç«¯æ²¡æœ‰ä½ç½®ä¸ŠæŠ¥æ—¥å¿—ï¼Œæˆ–åç«¯æ²¡æœ‰æ”¶åˆ°ä½ç½®æ›´æ–°è¯·æ±‚
**åŸå› **ï¼š
- æµè§ˆå™¨å®šä½æƒé™æœªæˆæƒ
- Tokenæ— æ•ˆæˆ–è¿‡æœŸ
- ç½‘ç»œè¿æ¥é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥æµè§ˆå™¨å®šä½æƒé™è®¾ç½®
- é‡æ–°ç™»å½•éª‘æ‰‹è´¦å·
- æ£€æŸ¥ç½‘ç»œè¿æ¥

### é—®é¢˜2ï¼šéª‘æ‰‹æ²¡æœ‰RiderProfileè®°å½•
**ç—‡çŠ¶**ï¼šåç«¯æ˜¾ç¤º `RowsAffected=0` å¹¶å°è¯•åˆ›å»ºæ–°profile
**åŸå› **ï¼š
- éª‘æ‰‹è´¦å·æ³¨å†Œæµç¨‹ä¸å®Œæ•´
- æ•°æ®åº“ä¸­ç¼ºå°‘å¯¹åº”çš„è®°å½•
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥éª‘æ‰‹æ³¨å†Œæµç¨‹
- æ‰‹åŠ¨åœ¨æ•°æ®åº“åˆ›å»ºRiderProfileè®°å½•

### é—®é¢˜3ï¼šè·ç¦»è®¡ç®—é”™è¯¯
**ç—‡çŠ¶**ï¼šåç«¯æ˜¾ç¤ºè·ç¦»è®¡ç®—ç»“æœä¸º0æˆ–å¼‚å¸¸å€¼
**åŸå› **ï¼š
- ç»çº¬åº¦æ•°æ®æ ¼å¼é”™è¯¯
- è·ç¦»è®¡ç®—ç®—æ³•é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç»çº¬åº¦æ•°æ®æœ‰æ•ˆæ€§
- éªŒè¯è·ç¦»è®¡ç®—å‡½æ•°

### é—®é¢˜4ï¼šå‰ç«¯ç»•è¿‡è·ç¦»æ ¡éªŒ
**ç—‡çŠ¶**ï¼šåç«¯æ²¡æœ‰æ”¶åˆ°é€è¾¾è¯·æ±‚
**åŸå› **ï¼š
- å‰ç«¯ç¼“å­˜äº†æˆåŠŸå“åº”
- APIè°ƒç”¨è¢«æ‹¦æˆª
- ç½‘ç»œè¯·æ±‚æœªå‘é€
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ—¥å¿—
- é‡æ–°åŠ è½½é¡µé¢

## ç´§æ€¥ä¿®å¤å»ºè®®

å¦‚æœè·ç¦»æ ¡éªŒç¡®å®å¤±æ•ˆï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹ç´§æ€¥æªæ–½ï¼š

1. **é™ä½è·ç¦»é˜ˆå€¼**ï¼šä¸´æ—¶é™ä½åˆ°50ç±³ï¼Œæé«˜ä¸¥æ ¼ç¨‹åº¦
2. **å¢åŠ å¼ºåˆ¶æ ¡éªŒ**ï¼šåœ¨APIå±‚é¢å¢åŠ åŒé‡æ ¡éªŒ
3. **æ·»åŠ å®æ—¶ä½ç½®æ£€æŸ¥**ï¼šåœ¨é€è¾¾å‰å®æ—¶æ£€æŸ¥éª‘æ‰‹ä½ç½®
4. **å¢åŠ æ—¥å¿—å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰é€è¾¾æ“ä½œçš„è¯¦ç»†ä¿¡æ¯

## ä¸´æ—¶ä¿®å¤ä»£ç 

å¦‚æœéœ€è¦å¿«é€Ÿä¿®å¤ï¼Œå¯ä»¥åœ¨é€è¾¾APIä¸­æ·»åŠ æ›´ä¸¥æ ¼çš„ä½ç½®æ£€æŸ¥ï¼š

```go
// å¼ºåˆ¶å®æ—¶è·å–æœ€æ–°ä½ç½®
var latestRiderProfile models.RiderProfile
if err := global.Db.Where("user_id = ?", baseUserID).Order("updated_at DESC").First(&latestRiderProfile).Error; err != nil {
    fail(c, "æ— æ³•è·å–æœ€æ–°éª‘æ‰‹ä½ç½®")
    return
}

// æ£€æŸ¥ä½ç½®æ•°æ®æ—¶æ•ˆæ€§ï¼ˆæœ€è¿‘5åˆ†é’Ÿå†…ï¼‰
if time.Since(latestRiderProfile.UpdatedAt) > 5*time.Minute {
    fail(c, "éª‘æ‰‹ä½ç½®æ•°æ®è¿‡æœŸï¼Œè¯·åˆ·æ–°ä½ç½®")
    return
}
```