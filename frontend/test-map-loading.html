<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图加载测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .map-container { width: 100%; height: 400px; border: 1px solid #ddd; margin: 20px 0; }
        .output { background: #f5f5f5; padding: 15px; border-radius: 8px; margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>高德地图加载测试</h1>

        <div class="output">
            <h3>环境变量检查:</h3>
            <div id="env-check">检查中...</div>
        </div>

        <button onclick="testMapLoading()">测试主密钥加载</button>
        <button onclick="testBackupKeyLoading()">测试备用密钥加载</button>
        <button onclick="clearOutput()">清空输出</button>

        <div class="output">
            <h3>测试输出:</h3>
            <pre id="output">点击上方按钮开始测试...</pre>
        </div>

        <div id="test-map" class="map-container" style="display: none;"></div>
    </div>

    <script>
        let outputDiv = document.getElementById('output');
        let envCheckDiv = document.getElementById('env-check');

        // 模拟环境变量
        const VITE_AMAP_KEY = '2c9226f684b41578b3780862f826c50f';
        const VITE_AMAP_SECURITY_CODE = 'f89d6b13c5416d0558b3c6c6c5e3e63';
        const VITE_AMAP_KEY_BACKUP = '4ba8ba0b6cc65d2f3258e44bb196a8c5';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
            outputDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function checkEnvironment() {
            envCheckDiv.innerHTML = `
                <p><strong>主密钥:</strong> ${VITE_AMAP_KEY ? VITE_AMAP_KEY.substring(0, 8) + '...' : '未设置'}</p>
                <p><strong>备用密钥:</strong> ${VITE_AMAP_KEY_BACKUP ? VITE_AMAP_KEY_BACKUP.substring(0, 8) + '...' : '未设置'}</p>
                <p><strong>安全代码:</strong> ${VITE_AMAP_SECURITY_CODE ? VITE_AMAP_SECURITY_CODE.substring(0, 8) + '...' : '未设置'}</p>
            `;
        }

        function loadMapScript(key, label) {
            return new Promise((resolve, reject) => {
                // 清理现有脚本
                const existingScript = document.querySelector('script[src*="webapi.amap.com"]');
                if (existingScript) {
                    existingScript.remove();
                }
                if (window.AMap) {
                    delete window.AMap;
                }

                // 设置安全配置
                if (VITE_AMAP_SECURITY_CODE) {
                    window._AMapSecurityConfig = {
                        securityJsCode: VITE_AMAP_SECURITY_CODE,
                    };
                    log('安全配置已设置');
                }

                const plugins = ['AMap.Geocoder', 'AMap.PlaceSearch', 'AMap.ToolBar'];
                const scriptUrl = `https://webapi.amap.com/maps?v=2.0&key=${key}&plugin=${plugins.join(',')}`;

                log(`尝试使用${label}加载地图: ${scriptUrl.substring(0, 50)}...`);

                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = scriptUrl;
                script.charset = 'utf-8';
                script.async = true;

                script.onload = () => {
                    setTimeout(() => {
                        if (window.AMap) {
                            log(`✅ ${label}加载成功! AMap对象可用: ${typeof window.AMap}`, 'success');
                            resolve(window.AMap);
                        } else {
                            log(`❌ ${label}脚本加载完成但AMap对象不可用`, 'error');
                            reject(new Error('AMap object not available'));
                        }
                    }, 200);
                };

                script.onerror = (error) => {
                    log(`❌ ${label}加载失败: ${error}`, 'error');
                    reject(error);
                };

                document.head.appendChild(script);
            });
        }

        async function testMapLoading() {
            try {
                log('开始测试主密钥...');
                const AMap = await loadMapScript(VITE_AMAP_KEY, '主密钥');

                // 显示地图容器
                document.getElementById('test-map').style.display = 'block';

                // 创建地图
                const map = new AMap.Map('test-map', {
                    zoom: 16,
                    center: [113.299, 23.099], // 中山大学
                    viewMode: '2D'
                });

                const marker = new AMap.Marker({
                    position: [113.299, 23.099],
                    title: '中山大学测试标记'
                });
                map.add(marker);

                log('地图创建成功，显示中山大学位置', 'success');

            } catch (error) {
                log(`主密钥测试失败: ${error.message}`, 'error');
            }
        }

        async function testBackupKeyLoading() {
            try {
                log('开始测试备用密钥...');
                const AMap = await loadMapScript(VITE_AMAP_KEY_BACKUP, '备用密钥');

                // 显示地图容器
                document.getElementById('test-map').style.display = 'block';

                // 创建地图
                const map = new AMap.Map('test-map', {
                    zoom: 16,
                    center: [113.299, 23.099], // 中山大学
                    viewMode: '2D'
                });

                const marker = new AMap.Marker({
                    position: [113.299, 23.099],
                    title: '中山大学测试标记 (备用密钥)'
                });
                map.add(marker);

                log('备用密钥测试成功，地图创建成功', 'success');

            } catch (error) {
                log(`备用密钥测试失败: ${error.message}`, 'error');
            }
        }

        function clearOutput() {
            outputDiv.textContent = '输出已清空...\n';
        }

        // 页面加载时检查环境
        checkEnvironment();
        log('地图测试工具已准备就绪');
    </script>
</body>
</html>