# 骑手端定位功能验收测试文档

## 📋 功能概述

骑手端定位系统确保骑手位置实时上报，支持距离校验的送达确认功能。

## 🎯 验收测试步骤

### 1. 环境准备

- ✅ 前端服务运行：`http://localhost:5174/`
- ✅ 后端服务运行：`http://localhost:3000/`
- ✅ 高德地图 API Key 已配置
- ✅ 测试骑手账号已准备

### 2. 登录和权限检查

#### 测试步骤：
1. **登录骑手账号**
   - 打开浏览器，访问骑手端登录页面
   - 输入骑手账号密码进行登录

2. **检查定位权限**
   - 登录成功后，查看右上角定位状态指示器
   - 应该自动请求定位权限（浏览器会弹出权限请求）
   - **预期结果**：
     - 首次登录：浏览器弹出定位权限请求
     - 允许后显示"已定位"（绿色指示器）
     - 拒绝后显示"定位失败(点重试)"（红色指示器，带脉冲动画）

3. **F12 控制台检查**
   - 打开开发者工具 Console
   - 查看定位相关日志输出
   - **预期结果**：
     ```
     🚀 [开始位置追踪] 时间: xx:xx:xx 说明: 骑手位置追踪已启动，将每15秒上报一次位置
     📍 [位置上报成功] 时间: xx:xx:xx 纬度: xx.xxxxxx 经度: xx.xxxxxx
     ```

### 3. 位置上报验证

#### 测试步骤：
1. **观察位置上报**
   - 在控制台观察位置上报日志
   - **预期结果**：每15秒上报一次位置，或位置变化超过20m时立即上报

2. **检查定位状态**
   - 查看右上角定位状态
   - **预期结果**：显示"已定位"，图标为绿色圆点

3. **模拟位置变化**
   - 在移动设备上走动，或使用开发者工具模拟位置
   - **预期结果**：位置变化超过20m时立即上报

### 4. 订单处理流程测试

#### 测试步骤：
1. **抢取订单**
   - 进入"待接单"页面
   - 抢取一个测试订单

2. **查看商家位置**
   - 订单进入"进行中"页面，状态为"待取餐"
   - 点击"查看商家位置"按钮
   - **预期结果**：
     - 弹出地图弹窗
     - 显示商家地址和标记
     - 无新窗口跳转

3. **确认取货**
   - 点击"确认取货"按钮
   - **预期结果**：订单状态变为"派送中"

4. **查看用户位置**
   - 点击"查看用户位置"按钮
   - **预期结果**：
     - 弹出地图弹窗
     - 显示用户收货地址和标记
     - 无新窗口跳转

5. **距离校验测试 - 场景A：在目标附近**
   - 物理移动到收货地址附近（150m内）
   - 点击"确认送达"按钮
   - **预期结果**：
     - 送达成功
     - 订单进入历史订单
     - 显示"已送达"成功消息

6. **距离校验测试 - 场景B：远离目标**
   - 远离收货地址（超过150m）
   - 点击"确认送达"按钮
   - **预期结果**：
     - 显示错误消息：`不在收货点附近（距离约 XXXm），无法确认送达`
     - 显示引导消息：`请导航至收货点附近再尝试送达`
     - 按钮保持可点击状态，不会卡死

7. **距离校验测试 - 场景C：无定位**
   - 在浏览器设置中禁用定位权限
   - 刷新页面，重新登录
   - 点击"确认送达"按钮
   - **预期结果**：
     - 显示错误消息：`未获取到骑手当前位置，请先上报定位`
     - 显示引导消息：`请打开浏览器定位权限/刷新页面后重试`
     - 右上角显示"定位失败(点重试)"

### 5. UI 和交互验证

#### 测试步骤：
1. **进行中页面状态显示**
   - 查看页面顶部的定位状态信息
   - **预期结果**：
     - 定位正常：显示"定位正常"（绿色）
     - 定位异常：显示"定位异常"（红色，脉冲动画）
     - 未定位：显示"未定位"（灰色）

2. **送达按钮提示信息**
   - 查看"确认送达"按钮下方的提示
   - **预期结果**：显示"送达需在收货点附近（150m内）"

3. **时间线显示**
   - 查看订单卡片上的时间线
   - **预期结果**：
     - 显示：已接单 → 已取货 → 配送中 → 已完成
     - 时间戳格式正确

4. **地图弹窗功能**
   - 测试地图弹窗的关闭、导航功能
   - **预期结果**：
     - 点击关闭按钮正常关闭
     - 点击"在地图应用中导航"打开外部导航

### 6. 错误处理和边界情况

#### 测试步骤：
1. **网络中断测试**
   - 断开网络连接
   - **预期结果**：
     - 位置上报失败，但不中断页面操作
     - 只在控制台显示错误日志
     - 不弹出刷屏错误提示

2. **浏览器兼容性**
   - 在不同浏览器中测试（Chrome、Firefox、Safari）
   - **预期结果**：定位功能正常工作

3. **移动端测试**
   - 在手机浏览器中测试
   - **预期结果**：响应式布局正常，定位功能可用

## ✅ 验收标准

### 核心功能
- [ ] 定位自动启动（登录后1秒内）
- [ ] 每15秒定时上报位置
- [ ] 位置变化超过20m立即上报
- [ ] 距离校验送达（150m阈值）
- [ ] 错误处理完善，不中断页面操作

### UI/UX
- [ ] 定位状态实时显示（已定位/定位失败/未定位）
- [ ] 错误消息清晰，包含引导信息
- [ ] 按钮保持可重复点击
- [ ] 地图弹窗内嵌显示，不跳新页面
- [ ] 移动端适配良好

### 技术要求
- [ ] 不使用 `window.open` 外链
- [ ] 不重复加载 AMap 脚本
- [ ] 后端距离校验正常工作
- [ ] 位置数据准确上报到 `/api/rider/location`

## 🐛 常见问题排查

### 1. 定位权限被拒绝
**现象**：右上角显示"定位失败(点重试)"，红色指示器闪烁
**解决**：
- 在浏览器设置中允许定位权限
- 刷新页面重新启动定位

### 2. 送达时提示距离不够
**现象**：点击"确认送达"显示距离错误
**解决**：
- 确保已到达收货地址附近（150m内）
- 检查定位是否正常工作
- 可点击"查看用户位置"确认目标位置

### 3. 位置上报失败
**现象**：控制台显示上报失败，但页面正常
**解决**：
- 检查网络连接
- 确认后端服务正常运行
- 重新登录启动定位

### 4. 地图弹窗无法显示
**现象**：点击查看位置按钮无反应
**解决**：
- 检查高德地图 API Key 配置
- 确认网络连接正常
- 查看控制台错误信息

## 📝 测试报告

请测试人员根据以上步骤逐一验证，并在每个测试项后标注结果：

- ✅ 通过
- ❌ 失败
- ⚠️ 部分通过

记录发现的问题和建议，以便开发团队进行修复。