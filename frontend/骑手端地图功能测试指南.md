# 骑手端地图功能测试指南

## 已完成的功能

### 1. 后端修复
- ✅ 修复 `DeliverOrder` 函数中的地址解析，使用高德地图 API
- ✅ 集成 `utils/geo_amap.go` 的 `GeoCode` 函数
- ✅ 正确处理地址到经纬度的转换

### 2. 前端优化
- ✅ AmapModal 组件正确显示商家和用户位置
- ✅ 地图弹窗使用 ElementPlus Dialog，不跳转新页面
- ✅ 地址字段正确映射：`pickupAddress` (商家) 和 `deliveryAddress` (用户)
- ✅ 优化定位状态管理，移除自动定位，改为手动控制

### 3. 按钮功能
- ✅ "去取货" → "查看商家位置" (仅打开地图弹窗)
- ✅ "去送达" → "查看用户位置" (仅打开地图弹窗)
- ✅ 保留 "确认取货" 和 "确认送达" 功能

## 测试步骤

### 1. 环境配置
确保 `.env.development` 文件包含正确的高德地图配置：
```env
VITE_AMAP_KEY=e3064e9e20ff62d8ebb59d24d634c179
VITE_AMAP_SECURITY_CODE=4bf89c4e16d60340e676f6cc39beff32
```

### 2. 测试地址解析
- 后端现在使用高德地图 API 进行地址解析
- 支持 "中山大学珠海校区" 等详细地址
- 解析失败会显示具体错误信息

### 3. 测试地图显示
- 点击 "查看商家位置" 应该弹出商家位置地图
- 点击 "查看用户位置" 应该弹出用户位置地图
- 地图使用内嵌高德地图 JS API，不打开新网页

### 4. 测试定位功能
- 右上角定位状态不再自动启动
- 点击定位区域会显示当前位置地图
- 定位失败显示 "定位失败(点重试)"

## 关键文件位置

### 后端
- `backend/controller/rider/orders.go` - 订单相关API和地址解析
- `backend/utils/geo_amap.go` - 高德地图地理编码工具

### 前端
- `frontend/src/components/AmapModal.vue` - 地图弹窗组件
- `frontend/src/utils/amap.ts` - 高德地图加载器
- `frontend/src/views/rider/RiderOngoing.vue` - 进行中订单页面
- `frontend/src/layout/rider/components/Navbar.vue` - 导航栏定位状态

## 注意事项

1. **API 密钥**：使用提供的高德地图密钥，或注册自己的密钥
2. **网络权限**：确保能访问 `restapi.amap.com` 进行地址解析
3. **浏览器定位**：地图功能不需要浏览器定位权限，但送达确认需要
4. **地址格式**：确保数据库中的地址字段包含足够的信息进行地理编码

## 故障排除

1. **地图不显示**：检查网络连接和高德地图 API 密钥
2. **地址解析失败**：检查地址字符串是否包含有效信息
3. **定位错误**：确保浏览器有定位权限（送达功能需要）
4. **按钮无响应**：检查前端控制台是否有 JavaScript 错误